<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>特教考卷朗讀製作工具</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; background: #eee; display: flex; flex-direction: column; align-items: center; padding-top: 60px; }
        #toolbar { position: fixed; top: 0; width: 100%; height: 50px; background: #333; color: white; display: flex; align-items: center; justify-content: center; z-index: 1000; gap: 15px; }
        .page-container { position: relative; margin: 20px; background: white; box-shadow: 0 0 10px rgba(0,0,0,0.2); cursor: crosshair; }
        canvas { display: block; width: 1000px; }
        .selection-box { position: absolute; border: 2px solid #ff4444; background: rgba(255, 68, 68, 0.1); pointer-events: auto; }
        button { padding: 5px 15px; cursor: pointer; border-radius: 4px; border: none; font-weight: bold; }
        #export-btn { background: #4caf50; color: white; }
        #file-input { color: white; }
    </style>
</head>
<body>
    <div id="toolbar">
        <input type="file" id="file-input" accept="application/pdf">
        <span>框選題目後點擊：</span>
        <button id="export-btn">完成並下載學生版</button>
    </div>
    <div id="viewer"></div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
        let pdfDoc = null, pagesData = [], currentBoxes = [];

        document.getElementById('file-input').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const arrayBuffer = await file.arrayBuffer();
            pdfDoc = await pdfjsLib.getDocument(arrayBuffer).promise;
            renderAllPages();
        });

        async function renderAllPages() {
            const viewer = document.getElementById('viewer');
            viewer.innerHTML = '';
            pagesData = [];
            for (let i = 1; i <= pdfDoc.numPages; i++) {
                const page = await pdfDoc.getPage(i);
                const viewport = page.getViewport({ scale: 2 });
                const container = document.createElement('div');
                container.className = 'page-container';
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                await page.render({ canvasContext: context, viewport: viewport }).promise;
                
                const imgData = canvas.toDataURL('image/png');
                const textContent = await page.getTextContent();
                const words = textContent.items.map(item => ({
                    text: item.str,
                    x: (item.transform[4] / page.view[2]) * 100,
                    y: (1 - (item.transform[5] / page.view[3])) * 100 * (page.view[3]/page.view[2]) // 簡化座標
                }));

                container.appendChild(canvas);
                setupDrawing(container, i - 1, imgData, words);
                viewer.appendChild(container);
            }
        }

        function setupDrawing(container, pageIdx, imgData, words) {
            pagesData[pageIdx] = { img: imgData, words: words };
            container.onmousedown = (e) => {
                const rect = container.getBoundingClientRect();
                const startX = e.clientX - rect.left, startY = e.clientY - rect.top;
                const box = document.createElement('div');
                box.className = 'selection-box';
                container.appendChild(box);

                const moveHandler = (me) => {
                    const curX = me.clientX - rect.left, curY = me.clientY - rect.top;
                    box.style.left = Math.min(startX, curX) + 'px';
                    box.style.top = Math.min(startY, curY) + 'px';
                    box.style.width = Math.abs(curX - startX) + 'px';
                    box.style.height = Math.abs(curY - startY) + 'px';
                };

                const upHandler = () => {
                    document.removeEventListener('mousemove', moveHandler);
                    document.removeEventListener('mouseup', upHandler);
                    const l = (parseFloat(box.style.left) / rect.width) * 100;
                    const t = (parseFloat(box.style.top) / rect.height) * 100;
                    const w = (parseFloat(box.style.width) / rect.width) * 100;
                    const h = (parseFloat(box.style.height) / rect.height) * 100;
                    
                    // 這裡簡化抓取逻辑，實際使用可再優化
                    currentBoxes.push({ pageIdx, l, t, w, h });
                    box.onclick = () => { /* 預覽功能 */ alert("已記錄此區域"); };
                };
                document.addEventListener('mousemove', moveHandler);
                document.addEventListener('mouseup', upHandler);
            };
        }

        document.getElementById('export-btn').onclick = () => {
            // 這裡會生成跟之前一樣的學生版 HTML 邏輯...
            alert("正在開發匯出功能，請先確認 GitHub 部署成功！");
        };
    </script>
</body>
</html>
