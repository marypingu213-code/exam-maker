<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>è£•æ–‡è³‡æºç­ - äº’å‹•è€ƒå·è£½ä½œèˆ‡ QR åˆ†äº«å·¥å…·</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; background: #eee; display: flex; flex-direction: column; align-items: center; padding-top: 60px; }
        #toolbar { position: fixed; top: 0; width: 100%; height: 60px; background: #004d40; color: white; display: flex; align-items: center; justify-content: center; z-index: 1000; gap: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        .page-container { position: relative; margin: 20px; background: white; box-shadow: 0 0 10px rgba(0,0,0,0.2); cursor: crosshair; }
        canvas { display: block; width: 1000px; }
        .selection-box { position: absolute; border: 2px solid #ff4444; background: rgba(255, 68, 68, 0.2); pointer-events: auto; }
        button { padding: 8px 12px; cursor: pointer; border-radius: 4px; border: none; font-weight: bold; }
        #export-btn { background: #ffc107; color: #333; }
        #qr-section { background: white; padding: 20px; margin: 20px; border-radius: 10px; display: none; flex-direction: column; align-items: center; border: 3px solid #004d40; }
        input[type="text"] { padding: 8px; width: 300px; border: 1px solid #ccc; border-radius: 4px; }
    </style>
</head>
<body>
    <div id="toolbar">
        <strong>è£•æ–‡è³‡æºç­å·¥å…·</strong>
        <input type="file" id="file-input" accept="application/pdf">
        <button id="export-btn">âœ… 1. ä¸‹è¼‰å­¸ç”Ÿç‰ˆ</button>
        <span style="margin-left:20px;">2. è²¼ä¸Šé›²ç«¯é€£çµç”Ÿæˆ QRï¼š</span>
        <input type="text" id="qr-input" placeholder="è«‹åœ¨æ­¤è²¼ä¸Šé›²ç«¯æª”æ¡ˆé€£çµ">
        <button onclick="generateQR()" style="background:#00796b; color:white;">ç”Ÿæˆ QR Code</button>
    </div>

    <div id="qr-section">
        <h3 style="margin-top:0;">å­¸ç”Ÿå¹³æ¿æƒæè™•</h3>
        <div id="qrcode"></div>
        <p style="color:#666; font-size:12px;">è«‹ç¢ºèªé›²ç«¯é€£çµå·²é–‹å•Ÿã€ŒçŸ¥é“é€£çµçš„äººå‡å¯æŸ¥çœ‹ã€</p>
        <button onclick="document.getElementById('qr-section').style.display='none'" style="background:#eee; margin-top:10px;">é—œé–‰è¦–çª—</button>
    </div>

    <div id="viewer"></div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
        let pagesData = [], currentBoxes = [];

        // PDF æ¸²æŸ“é‚è¼¯ (åŒå‰ç‰ˆ)
        document.getElementById('file-input').onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const arrayBuffer = await file.arrayBuffer();
            const pdfDoc = await pdfjsLib.getDocument(arrayBuffer).promise;
            const viewer = document.getElementById('viewer');
            viewer.innerHTML = ''; pagesData = []; currentBoxes = [];

            for (let i = 1; i <= pdfDoc.numPages; i++) {
                const page = await pdfDoc.getPage(i);
                const viewport = page.getViewport({ scale: 2 });
                const container = document.createElement('div');
                container.className = 'page-container';
                const canvas = document.createElement('canvas');
                canvas.height = viewport.height; canvas.width = viewport.width;
                await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;
                
                const imgBase64 = canvas.toDataURL('image/png');
                const textContent = await page.getTextContent();
                const words = textContent.items.map(item => ({
                    text: item.str, x: (item.transform[4] / page.view[2]) * 100, y: (1 - (item.transform[5] / page.view[3])) * 100
                }));
                container.appendChild(canvas);
                pagesData.push({ img: imgBase64, words: words });
                setupSelection(container, i - 1);
                viewer.appendChild(container);
            }
        };

        function setupSelection(container, pIdx) {
            container.onmousedown = (e) => {
                if (e.target.className === 'selection-box') return;
                const rect = container.getBoundingClientRect();
                const startX = e.clientX - rect.left, startY = e.clientY - rect.top;
                const box = document.createElement('div');
                box.className = 'selection-box';
                container.appendChild(box);
                const onMove = (me) => {
                    const curX = me.clientX - rect.left, curY = me.clientY - rect.top;
                    box.style.left = Math.min(startX, curX) + 'px'; box.style.top = Math.min(startY, curY) + 'px';
                    box.style.width = Math.abs(curX - startX) + 'px'; box.style.height = Math.abs(curY - startY) + 'px';
                };
                const onUp = () => {
                    document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onUp);
                    const l = (parseFloat(box.style.left) / rect.width) * 100;
                    const t = (parseFloat(box.style.top) / rect.height) * 100;
                    const r = ((parseFloat(box.style.left) + parseFloat(box.style.width)) / rect.width) * 100;
                    const b = ((parseFloat(box.style.top) + parseFloat(box.style.height)) / rect.height) * 100;
                    const text = pagesData[pIdx].words.filter(w => w.x >= l && w.x <= r && w.y >= t && w.y <= b).map(w => w.text).join("");
                    if (text.trim()) currentBoxes.push({ pIdx, l, t, w: r-l, h: b-t, text: text.trim() });
                    else container.removeChild(box);
                };
                document.addEventListener('mousemove', onMove); document.addEventListener('mouseup', onUp);
            };
        }

        // ç”¢ç”Ÿ QR Code çš„å‡½æ•¸
        function generateQR() {
            const url = document.getElementById('qr-input').value;
            if (!url) return alert("è«‹å…ˆè²¼ä¸Šé€£çµï¼");
            document.getElementById('qrcode').innerHTML = "";
            new QRCode(document.getElementById("qrcode"), { text: url, width: 200, height: 200 });
            document.getElementById('qr-section').style.display = 'flex';
        }

        // åŒ¯å‡ºå­¸ç”Ÿç‰ˆ HTML (åŒå‰ç‰ˆ)
        document.getElementById('export-btn').onclick = () => {
            if (currentBoxes.length === 0) return alert("è«‹å…ˆæ¡†é¸é¡Œç›®ï¼");
            let pagesHtml = "";
            pagesData.forEach((p, i) => {
                let triggers = currentBoxes.filter(box => box.pIdx === i)
                    .map(box => `<div class="speech-trigger" style="left:${box.l}%; top:${box.t}%; width:${box.w}%; height:${box.h}%;" onclick="speak('${box.text.replace(/'/g, "\\'").replace(/"/g, '&quot;')}')"></div>`)
                    .join("");
                pagesHtml += `<div class="page-container"><img src="${p.img}" style="width:100%;">${triggers}</div>`;
            });
            const finalDoc = `<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><style>body{margin:0;background:#333;display:flex;flex-direction:column;align-items:center;padding-top:70px;}#stop-btn{position:fixed;top:0;width:100%;height:60px;background:#004d40;color:white;font-size:24px;border:none;z-index:1000;}.page-container{position:relative;margin-bottom:20px;background:white;width:98vw;max-width:1000px;}.speech-trigger{position:absolute;background:rgba(255,255,0,0.01);cursor:pointer;}.speech-trigger:active{background:rgba(255,255,0,0.4);border:3px solid #ffc107;}</style></head><body><button id="stop-btn" onclick="window.speechSynthesis.cancel()">ğŸ›‘ è£•æ–‡è³‡æºç­-åœæ­¢å¿µæ›¸</button>${pagesHtml}<script>function speak(t){window.speechSynthesis.cancel();const m=new SpeechSynthesisUtterance(t);m.lang="zh-TW";m.rate=0.75;window.speechSynthesis.speak(m);}<\/script></body></html>`;
            const blob = new Blob([finalDoc], { type: 'text/html' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = "è£•æ–‡è³‡æºç­_å­¸ç”Ÿè€ƒå·.html";
            a.click();
        };
    </script>
</body>
</html>
