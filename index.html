<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>è£•æ–‡åœ‹å°è³‡æºç­ - äº’å‹•è€ƒå·è£½ä½œå·¥å…·</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; background: #eee; display: flex; flex-direction: column; align-items: center; padding-top: 60px; }
        #toolbar { position: fixed; top: 0; width: 100%; height: 55px; background: #333; color: white; display: flex; align-items: center; justify-content: center; z-index: 1000; gap: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        .page-container { position: relative; margin: 20px; background: white; box-shadow: 0 0 10px rgba(0,0,0,0.2); cursor: crosshair; }
        canvas { display: block; width: 1000px; }
        .selection-box { position: absolute; border: 2px solid #ff4444; background: rgba(255, 68, 68, 0.15); pointer-events: auto; }
        button { padding: 8px 16px; cursor: pointer; border-radius: 4px; border: none; font-weight: bold; }
        #export-btn { background: #4caf50; color: white; }
        #file-input { color: white; }
        .instructions { font-size: 14px; color: #ccc; }
    </style>
</head>
<body>
    <div id="toolbar">
        <input type="file" id="file-input" accept="application/pdf">
        <span class="instructions">æ»‘é¼ æ¡†é¸é¡Œç›®å¾Œé»æ“Šï¼š</span>
        <button id="export-btn">âœ… å®Œæˆä¸¦ä¸‹è¼‰å­¸ç”Ÿç‰ˆ</button>
    </div>
    <div id="viewer"></div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
        let pagesData = [], currentBoxes = [];

        // 1. è®€å–èˆ‡æ¸²æŸ“ PDF
        document.getElementById('file-input').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const arrayBuffer = await file.arrayBuffer();
            const pdfDoc = await pdfjsLib.getDocument(arrayBuffer).promise;
            const viewer = document.getElementById('viewer');
            viewer.innerHTML = '';
            pagesData = [];
            currentBoxes = [];

            for (let i = 1; i <= pdfDoc.numPages; i++) {
                const page = await pdfDoc.getPage(i);
                const scale = 2; // é«˜æ¸…ç¸®æ”¾
                const viewport = page.getViewport({ scale });
                const container = document.createElement('div');
                container.className = 'page-container';
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                await page.render({ canvasContext: context, viewport: viewport }).promise;
                
                const imgBase64 = canvas.toDataURL('image/png');
                const textContent = await page.getTextContent();
                
                // è™•ç†æ–‡å­—åº§æ¨™
                const words = textContent.items.map(item => ({
                    text: item.str,
                    x: (item.transform[4] / page.view[2]) * 100,
                    y: (1 - (item.transform[5] / page.view[3])) * 100
                }));

                container.appendChild(canvas);
                pagesData.push({ img: imgBase64, words: words, w: page.view[2], h: page.view[3] });
                setupSelection(container, i - 1);
                viewer.appendChild(container);
            }
            alert("è€ƒå·è®€å–æˆåŠŸï¼è«‹é–‹å§‹åœ¨é¡Œç›®ä¸Šæ¡†é¸ç¯„åœã€‚");
        });

        // 2. æ¡†é¸é‚è¼¯
        function setupSelection(container, pIdx) {
            container.onmousedown = (e) => {
                if (e.target.className === 'selection-box') return;
                const rect = container.getBoundingClientRect();
                const startX = e.clientX - rect.left, startY = e.clientY - rect.top;
                const box = document.createElement('div');
                box.className = 'selection-box';
                container.appendChild(box);

                const onMove = (me) => {
                    const curX = me.clientX - rect.left, curY = me.clientY - rect.top;
                    box.style.left = Math.min(startX, curX) + 'px';
                    box.style.top = Math.min(startY, curY) + 'px';
                    box.style.width = Math.abs(curX - startX) + 'px';
                    box.style.height = Math.abs(curY - startY) + 'px';
                };

                const onUp = () => {
                    document.removeEventListener('mousemove', onMove);
                    document.removeEventListener('mouseup', onUp);
                    
                    const l = (parseFloat(box.style.left) / rect.width) * 100;
                    const t = (parseFloat(box.style.top) / rect.height) * 100;
                    const r = ((parseFloat(box.style.left) + parseFloat(box.style.width)) / rect.width) * 100;
                    const b = ((parseFloat(box.style.top) + parseFloat(box.style.height)) / rect.height) * 100;

                    // æŠ“å–æ¡†å…§çš„æ–‡å­—
                    const text = pagesData[pIdx].words
                        .filter(w => w.x >= l && w.x <= r && w.y >= t && w.y <= b)
                        .map(w => w.text).join("");

                    if (text.trim()) {
                        currentBoxes.push({ pIdx, l, t, w: r - l, h: b - t, text: text.trim() });
                        box.title = "å·²è¨˜éŒ„é¡Œç›®å…§å®¹";
                    } else {
                        container.removeChild(box);
                    }
                };
                document.addEventListener('mousemove', onMove);
                document.addEventListener('mouseup', onUp);
            };
        }

        // 3. åŒ¯å‡ºå­¸ç”Ÿç‰ˆ HTML
        document.getElementById('export-btn').onclick = () => {
            if (currentBoxes.length === 0) return alert("è«‹å…ˆæ¡†é¸é¡Œç›®ï¼");

            let pagesHtml = "";
            pagesData.forEach((p, i) => {
                let triggers = currentBoxes.filter(box => box.pageIdx === i)
                    .map(box => `<div class="speech-trigger" style="left:${box.l}%; top:${box.t}%; width:${box.w}%; height:${box.h}%;" onclick="speak('${box.text.replace(/'/g, "\\'").replace(/"/g, '&quot;')}')"></div>`)
                    .join("");
                
                pagesHtml += `<div class="page-container"><img src="${p.img}" style="width:100%;">${triggers}</div>`;
            });

            const finalHTML = `
            <!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
            <style>
                body { margin: 0; background: #333; display: flex; flex-direction: column; align-items: center; padding-top: 70px; }
                #stop-btn { position: fixed; top: 0; width: 100%; height: 60px; background: #f44336; color: white; font-size: 24px; font-weight: bold; border: none; z-index: 1000; cursor: pointer; }
                .page-container { position: relative; margin-bottom: 20px; background: white; width: 98vw; max-width: 1000px; }
                .speech-trigger { position: absolute; background: rgba(255, 255, 0, 0.01); cursor: pointer; }
                .speech-trigger:active { background: rgba(255, 255, 0, 0.4); border: 3px solid red; }
            </style></head><body>
            <button id="stop-btn" onclick="window.speechSynthesis.cancel()">ğŸ›‘ åœæ­¢å¿µæ›¸</button>
            ${pagesHtml}
            <script>
                function speak(t) { window.speechSynthesis.cancel(); const m = new SpeechSynthesisUtterance(t); m.lang="zh-TW"; m.rate=0.75; window.speechSynthesis.speak(m); }
            <\/script></body></html>`;

            const blob = new Blob([finalHTML], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = "student_exam.html";
            a.click();
        };
    </script>
</body>
</html>
