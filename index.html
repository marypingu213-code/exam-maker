try:
    import fitz
except ImportError:
    import os
    os.system('pip install pymuPDF')
    import fitz

import html
import base64
import json
from google.colab import files

print("è«‹é¸æ“‡æ‚¨çš„ PDF è€ƒå·ï¼š")
uploaded = files.upload()

if uploaded:
    pdf_path = list(uploaded.keys())[0]
    doc = fitz.open(pdf_path)
    pages_data = []

    for page_num in range(len(doc)):
        page = doc[page_num]
        pix = page.get_pixmap(matrix=fitz.Matrix(2, 2))
        img_base64 = base64.b64encode(pix.tobytes("png")).decode("utf-8")
        
        # æŠ“å–æ‰€æœ‰æ–‡å­—ä»¥åˆ©å¾ŒçºŒå€åŸŸåŒ¹é…
        words = []
        for w in page.get_text("words"):
            words.append({
                "text": w[4],
                "x0": w[0] / page.rect.width * 100,
                "y0": w[1] / page.rect.height * 100,
                "x1": w[2] / page.rect.width * 100,
                "y1": w[3] / page.rect.height * 100
            })
        pages_data.append({"img": img_base64, "words": words})

    full_html = f'''
    <!DOCTYPE html><html><head><meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {{ margin: 0; background: #eee; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding-top: 60px; }}
        #toolbar {{ position: fixed; top: 0; width: 100%; height: 50px; background: #333; color: white; display: flex; align-items: center; justify-content: center; z-index: 1000; gap: 20px; }}
        .page-container {{ position: relative; margin: 20px; background: white; box-shadow: 0 0 10px rgba(0,0,0,0.2); cursor: crosshair; user-select: none; }}
        img {{ width: 1000px; display: block; pointer-events: none; }}
        .selection-box {{ position: absolute; border: 2px solid #ff4444; background: rgba(255, 68, 68, 0.1); pointer-events: none; }}
        .final-trigger {{ position: absolute; border: 1px dashed blue; background: rgba(0, 0, 255, 0.05); cursor: pointer; }}
        #save-btn {{ background: #4caf50; color: white; border: none; padding: 5px 15px; border-radius: 5px; cursor: pointer; }}
    </style></head><body>
    <div id="toolbar">
        <span>æ­¥é©Ÿï¼š1. ç”¨æ»‘é¼ æ¡†é¸é¡Œç›®ç¯„åœ  2. é»æ“Šã€Œå®Œæˆä¸¦ä¸‹è¼‰å­¸ç”Ÿç‰ˆã€</span>
        <button id="save-btn" onclick="exportHTML()">âœ… å®Œæˆä¸¦ä¸‹è¼‰å­¸ç”Ÿç‰ˆ</button>
    </div>
    <div id="paper"></div>
    <script>
        const pagesData = {json.dumps(pages_data)};
        let currentBoxes = [];
        const paper = document.getElementById('paper');
        
        pagesData.forEach((page, pIdx) => {{
            const div = document.createElement('div');
            div.className = 'page-container';
            div.style.width = '1000px';
            div.innerHTML = `<img src="data:image/png;base64,${{page.img}}">`;
            
            div.onmousedown = (e) => {{
                const rect = div.getBoundingClientRect();
                const startX = e.clientX - rect.left;
                const startY = e.clientY - rect.top;
                const box = document.createElement('div');
                box.className = 'selection-box';
                div.appendChild(box);
                
                document.onmousemove = (moveE) => {{
                    const curX = moveE.clientX - rect.left;
                    const curY = moveE.clientY - rect.top;
                    box.style.left = Math.min(startX, curX) + 'px';
                    box.style.top = Math.min(startY, curY) + 'px';
                    box.style.width = Math.abs(curX - startX) + 'px';
                    box.style.height = Math.abs(curY - startY) + 'px';
                }};
                
                document.onmouseup = () => {{
                    document.onmousemove = null;
                    document.onmouseup = null;
                    // è¨˜éŒ„åº§æ¨™
                    const xMin = (parseFloat(box.style.left) / 1000) * 100;
                    const yMin = (parseFloat(box.style.top) / (rect.height)) * 100;
                    const xMax = ((parseFloat(box.style.left) + parseFloat(box.style.width)) / 1000) * 100;
                    const yMax = ((parseFloat(box.style.top) + parseFloat(box.style.height)) / (rect.height)) * 100;
                    
                    // æ‰¾å‡ºæ¡†å…§æ–‡å­—
                    const text = pagesData[pIdx].words
                        .filter(w => w.x0 >= xMin && w.x1 <= xMax && w.y0 >= yMin && w.y1 <= yMax)
                        .map(w => w.text).join("");
                    
                    if(text.trim()) {{
                        currentBoxes.push({{ pIdx, xMin, yMin, xMax, yMax, text }});
                        box.onclick = () => {{ /* é è¦½æœ—è®€ */ window.speechSynthesis.cancel(); const m = new SpeechSynthesisUtterance(text); m.lang='zh-TW'; window.speechSynthesis.speak(m); }};
                        box.style.pointerEvents = 'auto';
                        box.title = "é»æ“Šé è¦½ï¼š " + text;
                    }} else {{
                        div.removeChild(box);
                    }}
                }};
            }};
            paper.appendChild(div);
        }});

        function exportHTML() {{
            let triggersByPage = {{}};
            currentBoxes.forEach(b => {{
                if(!triggersByPage[b.pIdx]) triggersByPage[b.pIdx] = "";
                triggersByPage[b.pIdx] += `<div class="speech-trigger" style="left:${{b.xMin}}%; top:${{b.yMin}}%; width:${{b.xMax-b.xMin}}%; height:${{b.yMax-b.yMin}}%;" onclick="speak('${{htmlEscape(b.text)}}')"></div>`;
            }});

            let pagesHtml = "";
            pagesData.forEach((p, i) => {{
                pagesHtml += `<div class="page-container"><img src="data:image/png;base64,${{p.img}}" style="width:100%;">${{triggersByPage[i] || ""}}</div>`;
            }});

            const finalDoc = `<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><style>body{{margin:0;background:#333;display:flex;flex-direction:column;align-items:center;padding-top:70px;}} #stop-btn{{position:fixed;top:0;width:100%;height:60px;background:#f44336;color:white;font-size:24px;border:none;z-index:1000;}} .page-container{{position:relative;margin-bottom:20px;background:white;width:98vw;max-width:1000px;}} .speech-trigger{{position:absolute;background:rgba(255,255,0,0.02);cursor:pointer;}} .speech-trigger:active{{background:rgba(255,255,0,0.4);border:3px solid red;}}</style></head><body><button id="stop-btn" onclick="window.speechSynthesis.cancel()">ğŸ›‘ åœæ­¢å¿µæ›¸</button>${{pagesHtml}}<script>function speak(t){{window.speechSynthesis.cancel();const m=new SpeechSynthesisUtterance(t);m.lang="zh-TW";m.rate=0.8;window.speechSynthesis.speak(m);}}<\/script></body></html>`;
            
            const blob = new Blob([finalDoc], {{type: 'text/html'}});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = "student_exam_custom.html";
            a.click();
        }}
        function htmlEscape(str) {{ return str.replace(/'/g, "\\\\'").replace(/"/g, '&quot;'); }}
    </script></body></html>
    '''
    with open("teacher_editor.html", "w", encoding="utf-8") as f:
        f.write(full_html)
    files.download("teacher_editor.html")
